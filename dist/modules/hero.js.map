{"version":3,"file":null,"sources":["../../src/modules/hero.ts"],"sourcesContent":["import { VNode, Module } from '../interfaces'\n\ninterface HeroVNode extends VNode {\n  isTextNode: boolean\n  boundingRect: ClientRect\n  textRect: ClientRect | null\n  savedStyle: any\n}\n\nconst raf = (typeof window !== 'undefined' && window.requestAnimationFrame) || setTimeout\nconst nextFrame = function(fn: any) { raf(function() { raf(fn) }) }\n\nfunction setNextFrame(obj: any, prop: string, val: any) {\n  nextFrame(function() { obj[prop] = val })\n}\n\nfunction getTextNodeRect(textNode: Text) {\n  let rect: ClientRect | null = null\n  if (document.createRange) {\n    let range = document.createRange()\n    range.selectNodeContents(textNode)\n    if (range.getBoundingClientRect) {\n      rect = range.getBoundingClientRect()\n    }\n  }\n  return rect\n}\n\nfunction calcTransformOrigin(isTextNode: boolean, textRect: ClientRect, boundingRect: ClientRect): string {\n  if (isTextNode) {\n    if (textRect) {\n      //calculate pixels to center of text from left edge of bounding box\n      let relativeCenterX = textRect.left + textRect.width / 2 - boundingRect.left\n      let relativeCenterY = textRect.top + textRect.height / 2 - boundingRect.top\n      return relativeCenterX + 'px ' + relativeCenterY + 'px'\n    }\n  }\n  return '0 0' //top left\n}\n\nfunction getTextDx(oldTextRect: ClientRect, newTextRect: ClientRect): number {\n  if (oldTextRect && newTextRect) {\n    return ((oldTextRect.left + oldTextRect.width / 2) - (newTextRect.left + newTextRect.width / 2))\n  }\n  return 0\n}\nfunction getTextDy(oldTextRect: ClientRect, newTextRect: ClientRect): number {\n  if (oldTextRect && newTextRect) {\n    return ((oldTextRect.top + oldTextRect.height / 2) - (newTextRect.top + newTextRect.height / 2))\n  }\n  return 0\n}\n\nfunction isTextElement(elm: Element | Text): boolean {\n  return elm.childNodes.length === 1 && elm.childNodes[0].nodeType === 3\n}\n\nlet removed: any\nlet created: any[]\n\nfunction pre() {\n  removed = {}\n  created = []\n}\n\nfunction create(_: VNode, vnode: VNode) {\n  let hero = vnode.data && vnode.data.hero\n  if (hero && hero.id) {\n    created.push(hero.id)\n    created.push(vnode)\n  }\n}\n\nfunction destroy(vnode: HeroVNode) {\n  let hero = vnode.data && vnode.data.hero\n  if (hero && hero.id) {\n    let elm = vnode.elm as Element\n    vnode.isTextNode = isTextElement(elm as Element) //is this a text node?\n    vnode.boundingRect = (elm as HTMLElement).getBoundingClientRect() //save the bounding rectangle to a new property on the vnode\n    vnode.textRect = vnode.isTextNode ? getTextNodeRect((elm as any).childNodes[0]) : null //save bounding rect of inner text node\n    let computedStyle = window.getComputedStyle((elm as HTMLElement)) //get current styles (includes inherited properties)\n    vnode.savedStyle = JSON.parse(JSON.stringify(computedStyle)) //save a copy of computed style values\n    removed[hero.id] = vnode\n  }\n}\n\nfunction post() {\n  let i: any\n  let id: any\n  let newElm: any\n  let oldVnode: HeroVNode\n  let oldElm: any\n  let hRatio: any\n  let wRatio: any\n  let oldRect: any\n  let newRect: any\n  let dx: any\n  let dy: any\n  let origTransform: any\n  let origTransition: any\n  let newStyle: any\n  let oldStyle: any\n  let newComputedStyle: any\n  let isTextNode: any\n  let newTextRect: any\n  let oldTextRect: any\n  for (i = 0; i < created.length; i += 2) {\n    id = created[i]\n    newElm = created[i + 1].elm\n    oldVnode = removed[id]\n    if (oldVnode) {\n      isTextNode = oldVnode.isTextNode && isTextElement(newElm) //Are old & new both text?\n      newStyle = newElm.style\n      newComputedStyle = window.getComputedStyle(newElm) //get full computed style for new element\n      oldElm = oldVnode.elm\n      oldStyle = oldElm.style\n      //Overall element bounding boxes\n      newRect = newElm.getBoundingClientRect()\n      oldRect = oldVnode.boundingRect //previously saved bounding rect\n      //Text node bounding boxes & distances\n      if (isTextNode) {\n        newTextRect = getTextNodeRect(newElm.childNodes[0])\n        oldTextRect = oldVnode.textRect\n        dx = getTextDx(oldTextRect, newTextRect)\n        dy = getTextDy(oldTextRect, newTextRect)\n      } else {\n        //Calculate distances between old & new positions\n        dx = oldRect.left - newRect.left\n        dy = oldRect.top - newRect.top\n      }\n      hRatio = newRect.height / (Math.max(oldRect.height, 1))\n      wRatio = isTextNode ? hRatio : newRect.width / (Math.max(oldRect.width, 1)) //text scales based on hRatio\n      // Animate new element\n      origTransform = newStyle.transform\n      origTransition = newStyle.transition\n      if (newComputedStyle.display === 'inline') //inline elements cannot be transformed\n        newStyle.display = 'inline-block'        //this does not appear to have any negative side effects\n      newStyle.transition = origTransition + 'transform 0s'\n      newStyle.transformOrigin = calcTransformOrigin(isTextNode, newTextRect, newRect)\n      newStyle.opacity = '0'\n      newStyle.transform = origTransform + 'translate(' + dx + 'px, ' + dy + 'px) ' +\n        'scale(' + 1 / wRatio + ', ' + 1 / hRatio + ')'\n      setNextFrame(newStyle, 'transition', origTransition)\n      setNextFrame(newStyle, 'transform', origTransform)\n      setNextFrame(newStyle, 'opacity', '1')\n      // Animate old element\n      for (let key in oldVnode.savedStyle) { //re-apply saved inherited properties\n        if (typeof key === 'number' && parseInt(key) !== key) {\n          let ms = (key as any).substring(0, 2) === 'ms'\n          let moz = (key as any).substring(0, 3) === 'moz'\n          let webkit = (key as any).substring(0, 6) === 'webkit'\n          if (!ms && !moz && !webkit) //ignore prefixed style properties\n            oldStyle[(key as any)] = oldVnode.savedStyle[(key as any)]\n        }\n      }\n      oldStyle.position = 'absolute'\n      oldStyle.top = oldRect.top + 'px' //start at existing position\n      oldStyle.left = oldRect.left + 'px'\n      oldStyle.width = oldRect.width + 'px' //Needed for elements who were sized relative to their parents\n      oldStyle.height = oldRect.height + 'px' //Needed for elements who were sized relative to their parents\n      oldStyle.margin = 0 //Margin on hero element leads to incorrect positioning\n      oldStyle.transformOrigin = calcTransformOrigin(isTextNode, oldTextRect, oldRect)\n      oldStyle.transform = ''\n      oldStyle.opacity = '1'\n      document.body.appendChild(oldElm)\n      // scale must be on far right for translate to be correct\n      setNextFrame(oldStyle, 'transform', 'translate(' + -dx + 'px, ' + -dy + 'px) scale(' + wRatio + ', ' + hRatio + ')')\n      setNextFrame(oldStyle, 'opacity', '0')\n      oldElm.addEventListener('transitionend', function (ev: TransitionEvent) {\n        if (ev.propertyName === 'transform')\n          document.body.removeChild(ev.target as Node)\n      })\n    }\n  }\n  removed = {}\n  created = []\n}\n\nexport const HeroModule: Module = {\n  pre,\n  create,\n  destroy,\n  post\n}"],"names":[],"mappings":"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"}